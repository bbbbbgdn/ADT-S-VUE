<template>
<div 
  class="project-card" 
  :class="{ 'use-img-tag': useImgTag }"
>
  <!-- Image container -->
  <div class="image-container">
    <ImageReveal
      v-if="useImgTag"
      :src="image"

      :imageStyle="imageStyle"
      @load="onLoad"
      @click="navigateToProject"
      @mouseenter="isHovering = true"
      @mouseleave="isHovering = false"
    />
    <div 
      v-else
      v-lazy-load="{ url: image, index: 0, resetQueue: true }"
      :data-index="0"
      class="project-card-background"
      @click="navigateToProject"
      @mouseenter="isHovering = true"
      @mouseleave="isHovering = false"
    ></div>
  </div>
  
  <!-- Tags are always shown -->
  <div class="project-tags">
    <BaseButton :to="`/projects/${slug}`" :class="{ 'button-hover': isHovering }">{{ projectName }}</BaseButton>
    <BaseButton v-if="year && year.trim().length > 0" variant="grey">{{ year }}</BaseButton>
  </div>
</div>
</template>

<script>
import BaseButton from './BaseButton.vue';
import ImageReveal from './ImageReveal.vue';
import lazyLoad from '../directives/lazyLoad';
import { useRouter } from 'vue-router';
import navigationManager from '../utils/navigationManager';
import { ref } from 'vue';

export default {
  name: 'ProjectCard',
  
  components: {
    BaseButton,
    ImageReveal
  },

  directives: {
    lazyLoad
  },

  props: {
    projectName: {
      type: String,
      default: 'Sample Project',
      required: true
    },
    year: {
      type: String,
      default: '',
      required: false
    },
    image: {
      type: String,
      default: '',
      required: true
    },
    slug: {
      type: String,
      required: true
    },
    useImgTag: {
      type: Boolean,
      default: true
    }
  },
  
  emits: ['click'],
  
  setup(props, { emit }) {
    const router = useRouter();
    const isHovering = ref(false);
    
    // Method to navigate with proper transition
    const navigateToProject = (event) => {
      // Only navigate if the click was directly on the card (not on a button)
      if (event.target.closest('.base-button') === null) {
        // Start navigation with transition
        navigationManager.navigateTo(router, `/projects/${props.slug}`);
        // Also emit click event for compatibility with existing code
        emit('click', props.slug);
      }
    };
    
    return {
      navigateToProject,
      isHovering
    };
  },
  
  data() {
    return {
      isLoaded: false,
      hasError: false,
      backgroundImage: '',
      shouldAnimate: false
    };
  },
  
  computed: {
    imageStyle() {
      return {
        position: 'absolute',
        top: 0,
        left: 0,
        width: '100%',
        height: '100%',
        objectFit: 'cover',
        zIndex: 0,
        cursor: 'pointer'
      };
    },
    cardStyle() {
      return {
        backgroundImage: this.useImgTag ? 'none' : this.backgroundImage
      };
    }
  },
  
  methods: {
    onLoad() {
      this.isLoaded = true;
    },
    
    setBackgroundImage(url) {
      this.backgroundImage = `url(${url})`;
      this.isLoaded = true;
    },
    
    setErrorState() {
      this.hasError = true;
    }
  },
  
  mounted() {
    // Check if this is the first visit
    this.shouldAnimate = !localStorage.getItem('hasSeenAnimation');
    
    // Log the image URL for debugging
    console.log(`ProjectCard mounted - Image URL: ${this.image}, Slug: ${this.slug}`);
    
    // Set animation as seen
    if (this.shouldAnimate) {
      localStorage.setItem('hasSeenAnimation', 'true');
    }
    
    // Manually preload the image to ensure it works
    if (!this.useImgTag) {
      const img = new Image();
      img.onload = () => {
        this.setBackgroundImage(this.image);
      };
      img.onerror = () => {
        console.error(`Failed to load image: ${this.image}`);
        this.setErrorState();
      };
      img.src = this.image;
    }
  }
}
</script>

<style scoped>
.project-card {
  position: relative;
  display: flex;
  align-items: flex-end;
  aspect-ratio: 16/10;
  height: 100%;
  overflow: hidden;
  background-color: transparent;
}

.image-container {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 0;
}

.project-card:hover .button-black {
  background-color: var(--color-pink-primary);
  color: black;
}

.project-card-background {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-size: cover;
  background-position: center;
  z-index: 0;
  cursor: pointer;
  opacity: 1;
}

.project-tags {
  position: relative;
  pointer-events: none !important;
  display: flex;
  align-items: flex-end;
  flex-wrap: wrap;
  margin: 3rem;
  z-index: 1;
  gap: 3rem;
}

.button-hover {
  background-color: var(--color-pink-primary) !important;
  color: black !important;
}

@media screen and (max-width: 640px) {
  .project-card {
    min-height: 30vh;
  }
}
</style> 

